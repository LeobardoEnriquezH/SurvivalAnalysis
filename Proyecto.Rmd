---
title: ""
date: ""
header-includes:
- \usepackage[utf8]{inputenc}
- \usepackage[spanish]{babel}
- \usepackage{graphicx}
- \usepackage{multirow,rotating}
- \pagenumbering{gobble}
- \usepackage{dcolumn}
- \usepackage{tabularx}
output: 
  pdf_document:
    toc: true
    toc_depth: 3
    includes:
      in_header: labels.tex
      before_body: cover.tex
csl: apa.csl
bibliography: fuentes1.bib
---

```{=tex}
\pagenumbering{gobble}
\pagenumbering{arabic}
```


```{r setup, include=FALSE }
knitr::opts_chunk$set(echo = T, fig.width = 6, fig.height = 3.5)

```

```{r, message=FALSE, include=FALSE,warning=FALSE, background=FALSE, comment=FALSE, engine.path=FALSE, cache=FALSE, out.extra=FALSE, results='hide'}

rm(list = ls())

pacman::p_load(tidyverse,
               kableExtra,
               cowplot,
               stargazer,knitr,viridis,dplyr,readr,scales,quantmod,texreg,tinytex, 
               tidyr, imager,lubridate,tseries, astsa, growthrates, tis, dynlm, 
               readxl, foreign, hrbthemes, gtsummary, corrplot, lm.beta, ggfortify,
               AER, lmtest, sandwich,GGally, performance, flextable, see, qqplotr,
               ggrepel, patchwork,boot, rempsyc, report,multcomp, car, broom, 
               corrplot)
```



```{r, echo=FALSE}
source("funciones.R")
```





# Introducción.

Este documento tiene dos principales objetivos generales, mostrar algunos elementos estadísticos del análisis de supervivencia y al mismo tiempo con base en unos datos de clientes bancarios hacer algunas predicciones sobre la pérdida de clientes. 

En la primera sección se hace la estadística descriptiva de los datos con los que se trabajará, para dar un contexto y un panorama general de la naturaleza y característricas de las variables. En la sección dos, haremos procesamiento de los datos en caso de que sea necesario por ejemplo tratar con valores perdidos, valores atípicos, etc. En la tercera sección se plantea y desarrolla el problema de supervivencia. Y finalmente, el la cuarta sección se presentan las principales conclusiones del trabajo. 


# 1. Estadística descriptiva y procesamiento de datos.

```{r, echo=FALSE}
data<-read.csv("train.csv")
```

La base de datos es de clientes de un banco con las siguientes variables: 

* id: número de fila de la observación, comenzando por el 0.
* CustomerId: número de cuenta del cliente.
* Surname: apellido.
* CreditScore: puntaje de crédito. 
* Geography: país de residencia. 
* Gender: género del cliente.
* Age: edad del cliente. 
* Tenure: cuántos años ha tenido cuenta bancaria en el Banco.
* Balance: saldo de la cuenta.
* NumOfProducts: número de productos bancarios en el Banco.
* HasCrCard: si tiene o no tarjeta de crédito (sí=1).
* IsActiveMember: si es miembro activo del banco (sí=1). 
* EstimatedSalary: salario estimado. 
* Exited: si el cliente ha dejado el banco por algún periodo (sí=1).



## Selección de variables y verificación de datos faltantes.

Primero tomaremos un subconjunto del conjunto total de variables, omitiremos variables que no utilizaremos en el análisis tales como id, CustomerId, y Surname. Luego mostraremos en el siguiente cuadro que no hay datos faltantes (NA's) para las variables elegidas. 


```{r, echo=FALSE}
datos <- subset(data, select = -c(id, CustomerId, Surname))
```


```{r, echo=FALSE}
NA_CreditScore<-sum(is.na(datos$CreditScore))
NA_Geography<-sum(is.na(datos$Geography))
NA_Gender<-sum(is.na(datos$Gender))
NA_Age<-sum(is.na(datos$Age))
NA_Tenure<-sum(is.na(datos$Tenure))
NA_Balance<-sum(is.na(datos$Balance))
NA_NumOfProducts<-sum(is.na(datos$NumOfProducts))
NA_HasCrCard<-sum(is.na(datos$HasCrCard))
NA_IsActiveMember<-sum(is.na(datos$IsActiveMember))
NA_EstimatedSalary<-sum(is.na(datos$EstimatedSalary))
NA_Exited<-sum(is.na(datos$Exited))

```


\begin{tabularx}{0.9\textwidth} { 
  | >{\raggedright\arraybackslash}X 
  | >{\centering\arraybackslash}X 
  | >{\centering\arraybackslash}X 
  | >{\raggedleft\arraybackslash}X | }
 \hline
 CreditScore : `r NA_CreditScore` & Geography: `r NA_Geography ` & Gender: `r NA_Gender `  & Age: `r NA_Age` \\
 \hline
 Tenure : `r NA_Tenure` & Balance: `r NA_Balance ` & NumOfProducts: `r NA_NumOfProducts `  & HasCrCard: `r NA_HasCrCard` \\
 \hline
 IsActiveMember : `r NA_IsActiveMember` & EstimatedSalary: `r NA_EstimatedSalary ` & Exited: `r NA_Exited `  & \\
\hline
\end{tabularx}





## Resumen de los datos numéricos y detección de outliers. 


```{r, echo=FALSE}
# Establecimiendo de escalas ordinales
datos$NumOfProducts <- factor(datos$NumOfProducts, levels= c("1","2","3","4"), order=TRUE)
```


```{r, echo=FALSE}
# Establecimiendo de variables tipo factor no ordinal
datos$Geography <- factor(datos$Geography)
datos$Gender <- factor(datos$Gender)
datos$HasCrCard <- factor(datos$HasCrCard)
datos$IsActiveMember <- factor(datos$IsActiveMember)
datos$Exited <- factor(datos$Exited)
```




```{r, echo=FALSE}
# Escalas
tipo <- sapply(datos, class)
continuas <-  which(tipo == "numeric") # continuas
enteras <- which(tipo == "integer") # enteras
numericas <- names(c(continuas,enteras))

# Variables Categóricas
nominales <- which( tipo == "factor") # categóricas
ordinales <- which( sapply(datos, is.ordered) )  # ordinales
fecha <- which(tipo == "Date") # Fecha
categoricas <- names(c(nominales, ordinales, fecha))
```




A continuación se muestra la estadística descriptiva de los valores numéricos relevantes. Son $165,034$ observaciones, con edades entre 18 y 92 años, con un balance de $0$ a $250,898$ unidades monetarias, con salario estimado de entre $11.58$ a $199,992.5$, un score de crédito de 350 a 850, y tenencia de cuenta bancaria de 0 a 10 años. El promedio de edad es de 38 años, con un balance promedio de $55,478$ unidades monetarias, un promedio de salario estimado de $112,575.8$, un promedio de credit score de $656.45$, y un promedio de tenencia de cuenta de 5 años. 


 
```{r, echo=FALSE, include=FALSE}
stargazer(datos[,numericas])
```
 
 
 \begin{table}[!htbp] \centering 
  \caption{} 
  \label{} 
\begin{tabular}{@{\extracolsep{5pt}}lccccc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
Statistic & \multicolumn{1}{c}{N} & \multicolumn{1}{c}{Mean} & \multicolumn{1}{c}{St. Dev.} & \multicolumn{1}{c}{Min} & \multicolumn{1}{c}{Max} \\ 
\hline \\[-1.8ex] 
Age & 165,034 & 38.126 & 8.867 & 18.000 & 92.000 \\ 
Balance & 165,034 & 55,478.090 & 62,817.660 & 0.000 & 250,898.100 \\ 
EstimatedSalary & 165,034 & 112,574.800 & 50,292.870 & 11.580 & 199,992.500 \\ 
CreditScore & 165,034 & 656.454 & 80.103 & 350 & 850 \\ 
Tenure & 165,034 & 5.020 & 2.806 & 0 & 10 \\ 
\hline \\[-1.8ex] 
\end{tabular} 
\end{table} 





A continuación se muestran los histogramas de frecuencias relativas, distribuciones o densidades y boxplot conjuntas para las variables numéricas.  Se pueden observar distribuciones multimodales, a escepción de la variable de edad. Por ejemplo, el balance tiene un sesgo muy notable a la izquierda, mientras que el salario estimado presenta una distribución multimodal muy irregular, y el credit score  por ser una variable discreta, se percibe con varios saltos. 

No se observan outliers importantes, en el caso de la edad, hay valores de 92 años, pero no los consideramos outliers, por lo que no quitamos estos valores que corresponde a 11 observaciones. 



```{r, echo=FALSE, fig.width=7}
# Histogramas
par(mfrow= c(1,2) )
multi.hist(datos[, numericas])
```
 
 
## Variables categóricas.


A continuación presentaremos las datos categóricos, por su frecuencia absoluta en la base de datos. En la base se tienen $71,884$ mujeres y $93,150$ hombres; $94,215$ son de Francia, $34,606$ de Alemania y $36,213$ de España; $77,374$ tiene un solo producto bancario, $84,291$ tienen dos, mientras que $2,894$ tienen tres productos, y $475$ tienen 4 productos; $40,606$ no tiene tarjeta de crédito y $124,428$ sí tiene; $82,885$ no es miembro activo y $82,149$ son miembros activos; y $130,113$ permanecen con el banco, mientras que $34,921$ salieron del banco por algún periodo.     



```{r, comment=FALSE, warning=FALSE, , echo=FALSE, fig.height=5}
genero = datos %>% group_by(Gender)%>% summarise(n = n())
plot1<-ggplot(data = genero, aes(x = Gender, y = n))+
  geom_bar(stat = "identity", fill = "skyblue")+
  labs(x = "Genero", y = " ")+
  ggtitle(" ")+theme_bw()+
  theme(axis.text.x = element_text(angle=90))

geography = datos %>% group_by(Geography)%>% summarise(n = n())
plot2<-ggplot(data = geography, aes(x = Geography, y = n))+
  geom_bar(stat = "identity", fill = "skyblue")+
  labs(x = "Geografia", y = " ")+
  ggtitle(" ")+theme_bw()+
  theme(axis.text.x = element_text(angle=90))

NumOfProducts = datos %>% group_by(NumOfProducts)%>% summarise(n = n())
plot3<-ggplot(data = NumOfProducts, aes(x = NumOfProducts, y = n))+
  geom_bar(stat = "identity", fill = "skyblue")+
  labs(x = "Numero de productos", y = " ")+
  ggtitle(" ")+theme_bw()+
  theme(axis.text.x = element_text(angle=90))

HasCrCard = datos %>% group_by(HasCrCard)%>% summarise(n = n())
plot4<-ggplot(data = HasCrCard, aes(x = HasCrCard, y = n))+
  geom_bar(stat = "identity", fill = "skyblue")+
  labs(x = "Si tiene tarjeta", y = " ")+
  ggtitle(" ")+theme_bw()+
  theme(axis.text.x = element_text(angle=90))

plot_grid(plot1, plot2, plot3, plot4, ncol=2)
```


```{r, comment=FALSE, warning=FALSE, echo=FALSE}

IsActiveMember = datos %>% group_by(IsActiveMember )%>% summarise(n = n())
plot1<-ggplot(data = IsActiveMember, aes(x = IsActiveMember, y = n))+
  geom_bar(stat = "identity", fill = "skyblue")+
  labs(x = "Es miembro activo", y = " ")+
  ggtitle(" ")+theme_bw()+
  theme(axis.text.x = element_text(angle=90))

Exited= datos %>% group_by(Exited)%>% summarise(n = n())
plot2<-ggplot(data = Exited, aes(x = Exited, y = n))+
  geom_bar(stat = "identity", fill = "skyblue")+
  labs(x = "Si salió", y = " ")+
  ggtitle(" ")+theme_bw()+
  theme(axis.text.x = element_text(angle=90))

plot_grid(plot1, plot2, ncol=2)
```




# 2. Relación entre variable de censura y covariables.




```{r, echo=FALSE}
fitlogit=glm(Exited~.-NumOfProducts-IsActiveMember, family = binomial(link="logit"), data=datos)
summary(fitlogit)
```


La pueba de los supuestos del modelo.


```{r, echo=FALSE, warning=FALSE,message=FALSE, fig.width = 8, fig.height = 4}
library(DHARMa)  #Los residuales simulados también son útiles en este caso
set.seed(123)
fitlogitres <- simulateResiduals(fittedModel = fitlogit)
plot(fitlogitres)
```



```{r, echo=FALSE}
deviance_df<-deviance(fitprobit)/df.residual(fitprobit)
```



La regla de dedo para verificar el **parámetro de dispersión** de 1, con la devianza de residuales entre grados de libertad, muestra un valor de `r deviance_df`, lo cual se acerca a 1. 






# 3. El problema de supervivencia. 



# Conclusiones



\newpage

# Referencias

<!-- <div id="refs"></div> -->










